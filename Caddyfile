{
  email vldmrelizarov@yandex.ru
}

app-kindplate.ru {
  reverse_proxy frontend:80
  encode gzip zstd
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    Referrer-Policy "strict-origin-when-cross-origin"
  }
}

api-kindplate.ru {
  # Обработка OPTIONS запросов (preflight) - до reverse_proxy
  @options {
    method OPTIONS
  }
  handle @options {
    header {
      Access-Control-Allow-Origin "https://app-kindplate.ru"
      Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
      Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
      Access-Control-Allow-Credentials "true"
      Access-Control-Max-Age "86400"
    }
    respond 204
  }
  
  reverse_proxy backend:5000 {
    header_up X-Forwarded-Proto {scheme}
    header_up X-Forwarded-For {remote_host}
    header_up X-Real-IP {remote_host}
    transport http {
      dial_timeout 10s
      response_header_timeout 30s
    }
    # Health check для проверки доступности бэкенда
    health_uri /health
    health_interval 10s
    health_timeout 5s
    # Увеличиваем время ожидания для медленных ответов
    health_status 200
  }
  
  encode gzip zstd
  
  # CORS заголовки для всех ответов
  header {
    Access-Control-Allow-Origin "https://app-kindplate.ru"
    Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
    Access-Control-Allow-Credentials "true"
    Access-Control-Max-Age "86400"
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    Referrer-Policy "strict-origin-when-cross-origin"
  }
}


